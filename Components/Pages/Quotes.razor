@page "/quotes"
@rendermode InteractiveServer
@using TestApp.Models
@using TestApp.Services
@using Microsoft.JSInterop
@inject QuoteService QuoteService
@inject IJSRuntime JSRuntime

<PageTitle>Quotes</PageTitle>

<h1>Quote Management</h1>

<div class="row">
    <div class="col-12">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Customer</th>
                    <th>Product</th>
                    <th>Unit Price</th>
                    <th>Quantity</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (Quote quote in quotes)
                {
                    <tr>
                        @if (editingId == quote.Id)
                        {
                            <td>@quote.Id</td>
                            <td> <input class="form-control @(IsCustomerNameValid() ? "" : "is-invalid")" @bind="draft!.CustomerName" /> </td>
                            <td> <input class="form-control @(IsProductNameValid() ? "" : "is-invalid")" @bind="draft!.ProductName" /> </td>
                            <td> <input type="number" step="0.01" class="form-control @(IsUnitPriceValid() ? "" : "is-invalid")" @bind="draft!.UnitPrice" /> </td>
                            <td> <input type="number" class="form-control @(IsQuantityValid() ? "" : "is-invalid")" @bind="draft!.Quantity" /> </td>

                            <td>@((draft!.UnitPrice * draft!.Quantity).ToString("C"))</td> // generate total price 

                            <td>
                                <select class="form-select" @bind="draft!.Status">
                                    <option>Draft</option>
                                    <option>Pending</option>
                                    <option>Approved</option>
                                    <option>Rejected</option>
                                </select>
                            </td>
                            <td>@quote.CreatedDate.ToString("MM/dd/yyyy")</td>
                            <td>
                                <button class="btn btn-sm btn-primary me-2" @onclick="SaveEdit" disabled="@(!IsFormValid())">Save</button>
                                <button class="btn btn-sm btn-secondary" @onclick="CancelEdit">Cancel</button>
                            </td>
                        }
                        else
                        {
                            <td>@quote.Id</td>
                            <td>@quote.CustomerName</td>
                            <td>@quote.ProductName</td>
                            <td>@quote.UnitPrice.ToString("C")</td>
                            <td>@quote.Quantity</td>
                            <td>@quote.TotalPrice.ToString("C")</td>
                            <td>@quote.Status</td>
                            <td>@quote.CreatedDate.ToString("MM/dd/yyyy")</td>
                            <td>
                                <!-- TODO: Add Edit and Delete buttons -->
                                <button class="btn btn-sm btn-outline-primary" @onclick="() => BeginEdit(quote)"> Edit</button>
                                <button class="btn btn-sm btn-outline-danger ms-2" @onclick="() => ConfirmDelete(quote.Id, quote.CustomerName)">Delete</button>
                            </td>
                            
                        }

                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@code {
    private List<Quote> quotes = new List<Quote>();
    private int? editingId;
    private Quote? draft;

    protected override void OnInitialized()
    {
        quotes = QuoteService.GetAllQuotes();
    }

    private void BeginEdit(Quote quote)
    {
        editingId = quote.Id;
        draft = new Quote
            {
                Id = quote.Id,
                CustomerName = quote.CustomerName,
                ProductName = quote.ProductName,
                UnitPrice = quote.UnitPrice,
                Quantity = quote.Quantity,
                CreatedDate = quote.CreatedDate,
                Status = quote.Status
            };
    }

    private void CancelEdit()
    {
        //cancel = null
        editingId = null;
        draft = null;
    }

    private void SaveEdit()
    {
        if (editingId is null || draft is null) return;

        // Validate numeric fields
        if (!IsValidNumericFields())
        {
            return; // Don't save if validation fails
        }

        // Persist changes using the service
        QuoteService.UpdateQuote(draft);
        
        // Refresh the local quotes list to reflect changes
        quotes = QuoteService.GetAllQuotes();

        CancelEdit();
    }

    private bool IsValidNumericFields()
    {
        if (draft == null) return false;

        // Check if UnitPrice is valid (greater than 0)
        if (draft.UnitPrice <= 0)
        {
            return false;
        }

        // Check if Quantity is valid (greater than 0 and whole number)
        if (draft.Quantity <= 0 || draft.Quantity % 1 != 0)
        {
            return false;
        }

        return true;
    }

    private bool IsUnitPriceValid()
    {
        return draft != null && draft.UnitPrice > 0;
    }

    private bool IsQuantityValid()
    {
        return draft != null && draft.Quantity > 0 && draft.Quantity % 1 == 0;
    }

    private bool IsFormValid()
    {
        return IsUnitPriceValid() && IsQuantityValid() && IsStringFieldsValid();
    }

    private bool IsCustomerNameValid()
    {
        return draft != null && !string.IsNullOrWhiteSpace(draft.CustomerName);
    }

    private bool IsProductNameValid()
    {
        return draft != null && !string.IsNullOrWhiteSpace(draft.ProductName);
    }

    private bool IsStringFieldsValid()
    {
        return IsCustomerNameValid() && IsProductNameValid();
    }

    private async Task ConfirmDelete(int id, string customerName)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
            $"Are you sure you want to delete the quote for {customerName}? This action cannot be undone.");
        
        if (confirmed)
        {
            DeleteQuote(id);
        }
    }

    private void DeleteQuote(int id)
    {
        // Delete from service
        QuoteService.DeleteQuote(id);
        
        // Refresh the local quotes list to reflect changes
        quotes = QuoteService.GetAllQuotes();
        
        // If we were editing this quote, cancel edit mode
        if (editingId == id)
        {
            CancelEdit();
        }
    }
}